<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>ç·´ç¿’ç”¨</title>
    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            text-align: center;
            margin-top: 40px;
        }

        #hand {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px;
        }

        .tile {
            width: 60px;
            height: 80px;
            border: 2px solid #555;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .tile:hover {
            transform: translateY(-5px);
        }

        .newTile {
            background: #ffe066;
        }

        /* ãƒ„ãƒ¢ç‰Œã‚’å¼·èª¿ */
        button {
            margin: 5px;
            padding: 8px 16px;
            font-size: 16px;
        }
    </style>
</head>

<body>

    <h2>ç·´ç¿’ç”¨</h2>
    <div id="hand"></div>

    <button id="newBtn">æ–°ã—ãå§‹ã‚ã‚‹</button>
    <button id="waitBtn">å¾…ã¡è¡¨ç¤º</button>
    <button id="tsumoBtn" style="display:none;">ãƒ„ãƒ¢ï¼</button>

    <div id="message"></div>
    <div id="yamaInfo"></div>

    <script>
        const tiles = [1, 2, 3, 4, 5, 6, 7, 8, 9];
        let hand = [];
        let lastDraw = null;
        let yama = [];
        let gameOver = false; // â† ãƒ„ãƒ¢å¾Œã«è€ƒå¯Ÿã™ã‚‹ãŸã‚

        function resetYama() {
            yama = [];
            for (let i = 1; i <= 9; i++) for (let j = 0; j < 4; j++) yama.push(i);
            shuffle(yama);
        }

        function shuffle(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        }

        function initHand() {
            resetYama();
            hand = [];
            lastDraw = null;
            gameOver = false;
            for (let i = 0; i < 4; i++) hand.push(yama.pop());
            drawTile(); // æœ€åˆã®ãƒ„ãƒ¢
            document.getElementById("tsumoBtn").style.display = "none";
            document.getElementById("message").textContent = "";
            renderHand();
            updateYamaInfo();
        }

        function renderHand() {
            const div = document.getElementById("hand");
            div.innerHTML = "";

            // ã‚½ãƒ¼ãƒˆã•ã‚ŒãŸ4æšï¼‹ãƒ„ãƒ¢ç‰Œï¼ˆå³ç«¯ï¼‰
            let displayTiles = [...hand];
            if (lastDraw) {
                const others = hand.slice(0, hand.length - 1).sort((a, b) => a - b);
                displayTiles = [...others, lastDraw];
            } else {
                displayTiles.sort((a, b) => a - b);
            }

            displayTiles.forEach((t, i) => {
                const isLast = (lastDraw && i === displayTiles.length - 1);
                const el = document.createElement("div");
                el.className = "tile" + (isLast ? " newTile" : "");
                el.textContent = t + "è¬";
                el.onclick = () => discardTile(i, displayTiles);
                div.appendChild(el);
            });

            checkAgari();
            updateYamaInfo();
        }

        function discardTile(index, displayTiles) {
            if (gameOver) return; // ä¸ŠãŒã‚Šå¾Œã¯ä½•ã‚‚ã—ãªã„
            if (hand.length !== 5) return;
            const clicked = displayTiles[index];
            const idx = hand.indexOf(clicked);
            if (idx !== -1) hand.splice(idx, 1);
            lastDraw = null;
            document.getElementById("message").textContent = "";
            renderHand();
            drawTile(); // â† è‡ªå‹•ã§ãƒ„ãƒ¢
        }

        function drawTile() {
            if (hand.length >= 5) return;
            if (yama.length === 0) {
                document.getElementById("message").textContent = "ğŸŒŠ æµå±€ï¼ˆå±±ãŒå°½ããŸï¼‰";
                gameOver = true;
                return;
            }
            const t = yama.pop();
            hand.push(t);
            lastDraw = t;
            renderHand();
        }

        // ä¸ŠãŒã‚Šåˆ¤å®šï¼šé ­(2æš)ï¼‹é †å­oråˆ»å­
        function checkAgari() {
            if (hand.length !== 5) return;
            const sorted = [...hand].sort((a, b) => a - b);
            for (let i = 0; i < sorted.length - 1; i++) {
                if (sorted[i] === sorted[i + 1]) {
                    const rest = sorted.filter((_, idx) => idx !== i && idx !== i + 1);
                    if (
                        (rest[1] === rest[0] + 1 && rest[2] === rest[1] + 1) || // é †å­
                        (rest[0] === rest[1] && rest[1] === rest[2])        // åˆ»å­
                    ) {
                        document.getElementById("tsumoBtn").style.display = "inline";
                        return;
                    }
                }
            }
            document.getElementById("tsumoBtn").style.display = "none";
        }

        // å¾…ã¡ç‰Œè¡¨ç¤ºï¼ˆãƒ„ãƒ¢ç‰Œã‚’é™¤ã„ãŸ4æšã§åˆ¤å®šï¼‰
        function showWait() {
            if (gameOver) return;
            let baseTiles = [...hand];
            if (lastDraw) baseTiles = baseTiles.slice(0, baseTiles.length - 1);
            if (baseTiles.length !== 4) {
                document.getElementById("message").textContent = "â€»4æšã®ã¨ãã«æŠ¼ã—ã¦ã­";
                return;
            }
            const waits = [];
            for (let t of tiles) {
                const counts = {};
                baseTiles.forEach(x => counts[x] = (counts[x] || 0) + 1);
                if ((counts[t] || 0) >= 4) continue;
                const test = [...baseTiles, t].sort((a, b) => a - b);
                for (let i = 0; i < test.length - 1; i++) {
                    if (test[i] === test[i + 1]) {
                        const rest = test.filter((_, idx) => idx !== i && idx !== i + 1);
                        if (
                            (rest[1] === rest[0] + 1 && rest[2] === rest[1] + 1) ||
                            (rest[0] === rest[1] && rest[1] === rest[2])
                        ) {
                            waits.push(t);
                            break;
                        }
                    }
                }
            }
            document.getElementById("message").textContent =
                waits.length ? `å¾…ã¡ç‰Œï¼š${waits.join("è¬ãƒ»")}è¬` : "ãƒ†ãƒ³ãƒ‘ã‚¤ã—ã¦ã„ã¾ã›ã‚“";
        }

        function updateYamaInfo() {
            document.getElementById("yamaInfo").textContent = `æ®‹ã‚Šå±±ï¼š${yama.length}æš`;
        }

        document.getElementById("tsumoBtn").onclick = () => {
            document.getElementById("message").textContent = "ğŸ€„ SEXï¼";
            document.getElementById("tsumoBtn").style.display = "none";
            gameOver = true; // â† ã“ã“ã§æ­¢ã‚ã‚‹ï¼ˆè€ƒå¯Ÿã‚¿ã‚¤ãƒ ï¼‰
        };
        document.getElementById("waitBtn").onclick = showWait;
        document.getElementById("newBtn").onclick = initHand;

        initHand();
    </script>
</body>

</html>
